<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,300;1,400;1,700&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.css" integrity="sha256-gkQVf8UKZgQ0HyuxL/VnacadJ+D2Kox2TCEBuNQg5+w=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Gemini","darkmode":true,"version":"8.22.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":true,"style":"mac","show_result":true},"fold":{"enable":false,"height":300},"bookmark":{"enable":true,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":{"valine":{"order":-1}}},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"},"path":"/search.xml","localsearch":{"enable":true,"top_n_per_article":1,"unescape":false,"preload":false,"trigger":"auto"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="libfuzzer学习">
<meta property="og:type" content="article">
<meta property="og:title" content="fuzz入门到入土（二）">
<meta property="og:url" content="http://example.com/2025/10/04/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%BA%8C%EF%BC%89/index.html">
<meta property="og:site_name" content="le0n-blog">
<meta property="og:description" content="libfuzzer学习">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/images/image-20251006134355599.png">
<meta property="og:image" content="http://example.com/images/image-20251006135339984.png">
<meta property="og:image" content="http://example.com/images/image-20251006140104131.png">
<meta property="og:image" content="http://example.com/images/image-20251006142416104.png">
<meta property="og:image" content="http://example.com/images/image-20251006153424312.png">
<meta property="og:image" content="http://example.com/images/image-20251006154652685.png">
<meta property="og:image" content="http://example.com/images/image-20251006201826212.png">
<meta property="og:image" content="http://example.com/images/image-20251006201839442.png">
<meta property="og:image" content="http://example.com/images/image-20251006202139274.png">
<meta property="og:image" content="http://example.com/images/image-20251006202935797.png">
<meta property="og:image" content="http://example.com/images/image-20251006204547504.png">
<meta property="og:image" content="http://example.com/images/image-20251006204825371.png">
<meta property="og:image" content="http://example.com/images/image-20251006205240330.png">
<meta property="og:image" content="http://example.com/images/image-20251006205823898.png">
<meta property="og:image" content="http://example.com/images/image-20251006210008026.png">
<meta property="article:published_time" content="2025-10-04T08:43:19.707Z">
<meta property="article:modified_time" content="2025-12-26T01:34:13.820Z">
<meta property="article:author" content="leon">
<meta property="article:tag" content="fuzz">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/image-20251006134355599.png">


<link rel="canonical" href="http://example.com/2025/10/04/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%BA%8C%EF%BC%89/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2025/10/04/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%BA%8C%EF%BC%89/","path":"2025/10/04/fuzz从入门到入土（二）/","title":"fuzz入门到入土（二）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>fuzz入门到入土（二） | le0n-blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">le0n-blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags<span class="badge">15</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories<span class="badge">8</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">33</span></a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
      <div class="search-header">
        <span class="search-icon">
          <i class="fa fa-search"></i>
        </span>
        <div class="search-input-container">
          <input autocomplete="off" autocapitalize="off" maxlength="80"
                placeholder="Searching..." spellcheck="false"
                type="search" class="search-input">
        </div>
        <span class="popup-btn-close" role="button">
          <i class="fa fa-times-circle"></i>
        </span>
      </div>
      <div class="search-result-container">
        <div class="search-result-icon">
          <i class="fa fa-spinner fa-pulse fa-5x"></i>
        </div>
      </div>
    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#LibFuzzer%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E8%BD%BB%E6%9D%BE%E6%89%BE%E5%88%B0%E5%BF%83%E8%84%8F%E5%87%BA%E8%A1%80%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.</span> <span class="nav-text">LibFuzzer学习（一）：轻松找到心脏出血漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#libFuzzer-demo"><span class="nav-number">1.1.</span> <span class="nav-text">libFuzzer demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fuzz%E8%BF%87%E7%A8%8B%E5%8F%8A%E6%97%A5%E5%BF%97%E8%A7%A3%E6%9E%90"><span class="nav-number">1.2.</span> <span class="nav-text">fuzz过程及日志解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%8D%E5%AD%90seed"><span class="nav-number">1.2.1.</span> <span class="nav-text">种子seed</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BE%93%E5%85%A5%E5%A4%A7%E5%B0%8F"><span class="nav-number">1.2.2.</span> <span class="nav-text">输入大小</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A6%86%E7%9B%96%E7%8E%87%E6%83%85%E5%86%B5"><span class="nav-number">1.2.3.</span> <span class="nav-text">覆盖率情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.2.4.</span> <span class="nav-text">漏洞类型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crash-%E6%96%87%E4%BB%B6"><span class="nav-number">1.2.5.</span> <span class="nav-text">crash 文件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%94%E7%A4%BAHeartbleed%EF%BC%88%E5%BF%83%E8%84%8F%E6%BB%B4%E8%A1%80%EF%BC%89%E6%BC%8F%E6%B4%9E"><span class="nav-number">1.3.</span> <span class="nav-text">演示Heartbleed（心脏滴血）漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#build-%E5%92%8C-target-%E8%AF%B4%E6%98%8E"><span class="nav-number">1.3.1.</span> <span class="nav-text">build 和 target 说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E8%AF%91target%E6%96%87%E4%BB%B6"><span class="nav-number">1.3.2.</span> <span class="nav-text">编译target文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8Cfuzz"><span class="nav-number">1.3.3.</span> <span class="nav-text">执行fuzz</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gdb%E9%AA%8C%E8%AF%81"><span class="nav-number">1.3.4.</span> <span class="nav-text">gdb验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A0%B8%E5%BF%83%E6%80%9D%E8%B7%AF"><span class="nav-number">1.3.4.1.</span> <span class="nav-text">核心思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%9A%E9%87%8D%E6%96%B0%E7%BC%96%E8%AF%91%E4%B8%80%E4%B8%AA%E7%94%A8%E4%BA%8E-GDB-%E8%B0%83%E8%AF%95%E7%9A%84%E7%89%88%E6%9C%AC"><span class="nav-number">1.3.4.2.</span> <span class="nav-text">第一步：重新编译一个用于 GDB 调试的版本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E4%BD%BF%E7%94%A8-GDB-%E5%90%AF%E5%8A%A8%E5%B9%B6%E5%88%86%E6%9E%90"><span class="nav-number">1.3.4.3.</span> <span class="nav-text">第二步：使用 GDB 启动并分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.3.4.4.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#LibFuzzer%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E6%8F%90%E9%AB%98%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87%E5%92%8C%E9%80%9F%E5%BA%A6"><span class="nav-number">2.</span> <span class="nav-text">LibFuzzer学习（二）：提高代码覆盖率和速度</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">2.1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8C%87%E5%AE%9Aseed-corpus%E6%8F%90%E9%AB%98%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87"><span class="nav-number">2.2.</span> <span class="nav-text">指定seed corpus提高代码覆盖率</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%B8%B8%E4%BD%BF%E7%94%A8libfuzzer"><span class="nav-number">2.2.1.</span> <span class="nav-text">正常使用libfuzzer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9Aseed-corpus%E5%86%8D%E6%AC%A1%E6%89%A7%E8%A1%8Clibfuzzer"><span class="nav-number">2.2.2.</span> <span class="nav-text">指定seed corpus再次执行libfuzzer</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%A4%9A%E6%A0%B8%E5%B9%B6%E8%A1%8Cfuzz"><span class="nav-number">2.3.</span> <span class="nav-text">使用多核并行fuzz</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%97%E5%85%B8"><span class="nav-number">2.4.</span> <span class="nav-text">字典</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E9%A1%B9%E7%9B%AE%E6%9E%84%E5%BB%BA"><span class="nav-number">2.4.1.</span> <span class="nav-text">测试项目构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AF%94%E5%AF%B9%E4%BB%A3%E7%A0%81%E8%A6%86%E7%9B%96%E7%8E%87"><span class="nav-number">2.4.2.</span> <span class="nav-text">比对代码覆盖率</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="leon"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">leon</p>
  <div class="site-description" itemprop="description">Take more notes to reach higher efficiency.</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">33</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/le0n-daily" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;le0n-daily" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:1192876128@qq.com" title="E-Mail → mailto:1192876128@qq.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/10/04/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%BA%8C%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="leon">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="le0n-blog">
      <meta itemprop="description" content="Take more notes to reach higher efficiency.">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="fuzz入门到入土（二） | le0n-blog">
      <meta itemprop="description" content="libfuzzer学习">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          fuzz入门到入土（二）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-10-04 16:43:19" itemprop="dateCreated datePublished" datetime="2025-10-04T16:43:19+08:00">2025-10-04</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-12-26 09:34:13" itemprop="dateModified" datetime="2025-12-26T09:34:13+08:00">2025-12-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/fuzz/" itemprop="url" rel="index"><span itemprop="name">fuzz</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="post-meta-item-text">Views: </span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="Word count in article">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">Word count in article: </span>
      <span>35k</span>
    </span>
    <span class="post-meta-item" title="Reading time">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">Reading time &asymp;</span>
      <span>31 mins.</span>
    </span>
</div>

            <div class="post-description">libfuzzer学习</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="LibFuzzer学习（一）：轻松找到心脏出血漏洞"><a href="#LibFuzzer学习（一）：轻松找到心脏出血漏洞" class="headerlink" title="LibFuzzer学习（一）：轻松找到心脏出血漏洞"></a>LibFuzzer学习（一）：轻松找到心脏出血漏洞</h1><p>和AFL的区别在于LibFuzzer可以直接在进程中尝试输入数据，而AFL多的在于从外部将变异数据传入被测试程序内部。</p>
<h2 id="libFuzzer-demo"><a href="#libFuzzer-demo" class="headerlink" title="libFuzzer demo"></a>libFuzzer demo</h2><p><strong>demo解析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stddef.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">FuzzMe</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> DataSize)</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> DataSize &gt;= <span class="number">3</span> &amp;&amp;</span><br><span class="line">      Data[<span class="number">0</span>] == <span class="string">&#x27;L&#x27;</span> &amp;&amp;</span><br><span class="line">      Data[<span class="number">1</span>] == <span class="string">&#x27;e&#x27;</span> &amp;&amp;</span><br><span class="line">      Data[<span class="number">2</span>] == <span class="string">&#x27;0&#x27;</span> &amp;&amp;</span><br><span class="line">      Data[<span class="number">3</span>] == <span class="string">&#x27;n&#x27;</span> &amp;&amp;</span><br><span class="line">      Data[<span class="number">4</span>] == <span class="string">&#x27;.&#x27;</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="type">int</span> <span class="title function_">LLVMFuzzerTestOneInput</span><span class="params">(<span class="type">const</span> <span class="type">uint8_t</span> *Data, <span class="type">size_t</span> Size)</span> &#123;</span><br><span class="line">  FuzzMe(Data, Size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个程序非常简单，首先看一下FuzzMe()函数。接收参数主要有两个，一个是字符串<code>Date</code>，另一个是字符串长度<code>DateSize</code>。如果字符串长度大于3，且Data中数据前5个字节为<code>le0n.</code>则返回1，如果上述中一项不满足则返回0</p>
<p>然后，一般的C++程序都会存在一个main()函数作为入口，但是在这个demo中main()函数被<code>LLVMFuzzerTestOneInput()</code>函数取代了，这是因为libfuzzer需要在进程内为程序提供了输入参数，libfuzzer库内部存在main()函数，这样一来libfuzzer可以自由控制输入，因此在使用libfuzzer时，需要使用LLVMFuzzerTestOneInput()函数来代替main()函数作为执行入口</p>
<p><strong>编译目标程序</strong></p>
<p>目标程序需要使用clang进行编译，libFuzzer的代码覆盖率也是有LLVM内部工具提供的，如果一下载最新版的clang编译器（版本&gt;6.0），就可以直接使用libFuzzer，无需额外安装</p>
<p>目标程序需要使用 clang 进行编译，libFuzzer 的代码覆盖率信息也是由 LLVM 内部工具提供了，如果你已经下载了最新版的 clang 编译器（版本 &gt; 6.0），就可以直接使用 libFuzzer，无需额外安装。</p>
<p>在 clang 编译和链接时，可以使用 <code>-fsanitize=fuzzer</code> 标志启用 libFuzzer，这个参数时必须使用的，为了告知 libFuzzer 库准备进行链接，同时也可以结合 AddressSanitizer (ASAN)、UndefinedBehaviorSanitizer (UBSAN)、MemorySanitizer (MSAN) 一起使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">clang -g -fsanitize=fuzzer demo.c         <span class="comment"># 直接构建 fuzz 目标文件</span></span><br><span class="line">clang -g -fsanitize=fuzzer,address demo.c  <span class="comment"># 构建 fuzz 目标文件并附加 ASAN 检测（推荐使用）</span></span><br><span class="line">clang -g -fsanitize=fuzzer,signed-integer-overflow demo.c  <span class="comment"># 构建 fuzz 目标文件并附加一部分 UBSAN</span></span><br><span class="line">clang -g -fsanitize=fuzzer,memory demo.c  <span class="comment"># 构建 fuzz 目标文件并附加 MSAN</span></span><br></pre></td></tr></table></figure>

<p>那么回到上面的 demo 中，由于它是一个 C++ 程序，所以这里选用 clang++ 进行编译：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -O0 -g -fsanitize=fuzzer,address ./demo.cc -o demo</span><br></pre></td></tr></table></figure>

<p>这里在我的ubuntu22.04上编译时要用O0，不能用O1，如下：</p>
<p><strong>使用 <code>-O0</code>（无优化）</strong>：</p>
<p>assembly</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 编译器为每个条件生成独立的基本块</span><br><span class="line">cmp     DataSize, 5</span><br><span class="line">jl      .Lfalse</span><br><span class="line">mov     rax, Data</span><br><span class="line">cmp     byte ptr [rax], &#x27;L&#x27;</span><br><span class="line">jne     .Lfalse  </span><br><span class="line">cmp     byte ptr [rax+1], &#x27;e&#x27;</span><br><span class="line">jne     .Lfalse</span><br><span class="line">cmp     byte ptr [rax+2], &#x27;0&#x27;</span><br><span class="line">jne     .Lfalse</span><br><span class="line"># ... 更多独立检查</span><br></pre></td></tr></table></figure>

<p><strong>使用 <code>-O1</code>（中等优化）</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 编译器可能合并条件，减少分支</span><br><span class="line">cmp     DataSize, 3</span><br><span class="line">jl      .Lfalse</span><br><span class="line">mov     rax, Data</span><br><span class="line">mov     rcx, [rax]        # 一次加载多个字节</span><br><span class="line">and     rcx, 0xFFFFFFFF   # 掩码操作</span><br><span class="line">cmp     rcx, 0x6E30654C   # 比较 &quot;Le0n&quot; 的整数值</span><br><span class="line"># ... 更少的基本块</span><br></pre></td></tr></table></figure>

<p>O1会让编译器在编译过程中进行优化(采用&amp;&amp;的短路原理减少内存块的分配)。这样一来就得到了编译好的程序 <code>demo</code>。</p>
<h2 id="fuzz过程及日志解析"><a href="#fuzz过程及日志解析" class="headerlink" title="fuzz过程及日志解析"></a>fuzz过程及日志解析</h2><p>由于libFuzzer是与程序源码一起进行编译的，所以无需再程序外部做其他的配置，直接运行编译后的程序<code>demo</code>将会看到下面的日志结果：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo1/ $ ./demo_O0</span><br><span class="line">INFO: Running with entropic power schedule (0xFF, 100).</span><br><span class="line">INFO: Seed: 3203650924</span><br><span class="line">INFO: Loaded 1 modules   (8 inline 8-bit counters): 8 [0x64fd57b29ed0, 0x64fd57b29ed8),</span><br><span class="line">INFO: Loaded 1 PC tables (8 PCs): 8 [0x64fd57b29ed8,0x64fd57b29f58),</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line"><span class="comment">#2      INITED cov: 3 ft: 3 corp: 1/1b exec/s: 0 rss: 30Mb</span></span><br><span class="line"><span class="comment">#12     NEW    cov: 4 ft: 4 corp: 2/4b lim: 4 exec/s: 0 rss: 30Mb L: 3/3 MS: 5 CopyPart-ChangeByte-ChangeByte-CrossOver-CrossOver-</span></span><br><span class="line"><span class="comment">#658    NEW    cov: 5 ft: 5 corp: 3/7b lim: 8 exec/s: 0 rss: 30Mb L: 3/3 MS: 1 CMP- DE: &quot;L\000&quot;-</span></span><br><span class="line"><span class="comment">#5541   NEW    cov: 6 ft: 6 corp: 4/12b lim: 53 exec/s: 0 rss: 31Mb L: 5/5 MS: 3 PersAutoDict-CopyPart-CMP- DE: &quot;L\000&quot;-&quot;e\000&quot;-</span></span><br><span class="line"><span class="comment">#5678   REDUCE cov: 6 ft: 6 corp: 4/11b lim: 53 exec/s: 0 rss: 31Mb L: 4/4 MS: 2 ShuffleBytes-EraseBytes-</span></span><br><span class="line"><span class="comment">#7109   REDUCE cov: 6 ft: 6 corp: 4/10b lim: 63 exec/s: 0 rss: 31Mb L: 3/3 MS: 1 EraseBytes-</span></span><br><span class="line">=================================================================</span><br><span class="line">==15295==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6020000432d3 at pc 0x64fd57ae6f2e bp 0x7ffc3abb1d20 sp 0x7ffc3abb1d18</span><br><span class="line">READ of size 1 at 0x6020000432d3 thread T0</span><br><span class="line">    <span class="comment">#0 0x64fd57ae6f2d in FuzzMe(unsigned char const*, unsigned long) /home/le0n/fuzz/libFuzzer/demo1/./demo.cc:9:7</span></span><br><span class="line">    <span class="comment">#1 0x64fd57ae7044 in LLVMFuzzerTestOneInput /home/le0n/fuzz/libFuzzer/demo1/./demo.cc:14:3</span></span><br><span class="line">    <span class="comment">#2 0x64fd57a0d323 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3e323) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#3 0x64fd57a0ca79 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3da79) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#4 0x64fd57a0e269 in fuzzer::Fuzzer::MutateAndTestOne() (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3f269) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#5 0x64fd57a0ede5 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, std::allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3fde5) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#6 0x64fd579fcf22 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x2df22) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#7 0x64fd57a26c12 in main (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x57c12) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#8 0x7e091ce29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line">    <span class="comment">#9 0x7e091ce29e3f in __libc_start_main csu/../csu/libc-start.c:392:3</span></span><br><span class="line">    <span class="comment">#10 0x64fd579f1964 in _start (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x22964) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line"></span><br><span class="line">0x6020000432d3 is located 0 bytes to the right of 3-byte region [0x6020000432d0,0x6020000432d3)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x64fd57ae485d in operator new[](unsigned long) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x11585d) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#1 0x64fd57a0d232 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3e232) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#2 0x64fd57a0ca79 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3da79) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#3 0x64fd57a0e269 in fuzzer::Fuzzer::MutateAndTestOne() (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3f269) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#4 0x64fd57a0ede5 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, std::allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x3fde5) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#5 0x64fd579fcf22 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x2df22) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#6 0x64fd57a26c12 in main (/home/le0n/fuzz/libFuzzer/demo1/demo_O0+0x57c12) (BuildId: 899e8b30ca0eaa16c1c8eb74df44aaf04c41db09)</span></span><br><span class="line">    <span class="comment">#7 0x7e091ce29d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/le0n/fuzz/libFuzzer/demo1/./demo.cc:9:7 <span class="keyword">in</span> FuzzMe(unsigned char const*, unsigned long)</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x0c0480000600: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  0x0c0480000610: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fd</span><br><span class="line">  0x0c0480000620: fa fa fd fd fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  0x0c0480000630: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">  0x0c0480000640: fa fa fd fa fa fa fd fa fa fa fd fa fa fa fd fa</span><br><span class="line">=&gt;0x0c0480000650: fa fa fd fa fa fa fd fa fa fa[03]fa fa fa fa fa</span><br><span class="line">  0x0c0480000660: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c0480000670: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c0480000680: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c0480000690: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c04800006a0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07</span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="built_in">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      <span class="built_in">fc</span></span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">==15295==ABORTING</span><br><span class="line">MS: 1 ChangeByte-; base unit: 147f5286f0f0f6e81d00e810d1f49361f173b3f6</span><br><span class="line">0x4c,0x65,0x30,</span><br><span class="line">Le0</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-10a45a293f07e88f3b4651bcfc0dd2cf6cb6a162</span><br><span class="line">Base64: TGUw</span><br></pre></td></tr></table></figure>

<h3 id="种子seed"><a href="#种子seed" class="headerlink" title="种子seed"></a>种子seed</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO: Seed: 3203650924</span><br></pre></td></tr></table></figure>

<p>这里在程序执行时会生成一个seed随机种子，</p>
<h3 id="输入大小"><a href="#输入大小" class="headerlink" title="输入大小"></a>输入大小</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpu</span><br></pre></td></tr></table></figure>

<p>这里提示没有指定<code>-max_len</code>参数，所以libFuzzer默认<code>4096</code>字节作为最大输入字节，并且提示没有指定一个语料库</p>
<h3 id="覆盖率情况"><a href="#覆盖率情况" class="headerlink" title="覆盖率情况"></a>覆盖率情况</h3><figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#2      INITED cov: 3 ft: 3 corp: 1/1b exec/s: 0 rss: 30Mb</span></span><br><span class="line"><span class="comment">#12     NEW    cov: 4 ft: 4 corp: 2/4b lim: 4 exec/s: 0 rss: 30Mb L: 3/3 MS: 5 CopyPart-ChangeByte-ChangeByte-CrossOver-CrossOver-</span></span><br><span class="line"><span class="comment">#658    NEW    cov: 5 ft: 5 corp: 3/7b lim: 8 exec/s: 0 rss: 30Mb L: 3/3 MS: 1 CMP- DE: &quot;L\000&quot;-</span></span><br><span class="line"><span class="comment">#5541   NEW    cov: 6 ft: 6 corp: 4/12b lim: 53 exec/s: 0 rss: 31Mb L: 5/5 MS: 3 PersAutoDict-CopyPart-CMP- DE: &quot;L\000&quot;-&quot;e\000&quot;-</span></span><br><span class="line"><span class="comment">#5678   REDUCE cov: 6 ft: 6 corp: 4/11b lim: 53 exec/s: 0 rss: 31Mb L: 4/4 MS: 2 ShuffleBytes-EraseBytes-</span></span><br><span class="line"><span class="comment">#7109   REDUCE cov: 6 ft: 6 corp: 4/10b lim: 63 exec/s: 0 rss: 31Mb L: 3/3 MS: 1 EraseBytes-</span></span><br></pre></td></tr></table></figure>

<p>这段信息就是libFuzzer覆盖率情况，这里表示libFuzzer至少运行了7109次（#7109），共发现10个字节中的4给输入字节(4&#x2F;10b)，共覆盖了6个基本块（cov：6）</p>
<h3 id="漏洞类型"><a href="#漏洞类型" class="headerlink" title="漏洞类型"></a>漏洞类型</h3><p>后面就是ASan的日志信息了：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">==15295==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6020000432d3 at pc 0x64fd57ae6f2e bp 0x7ffc3abb1d20 sp 0x7ffc3abb1d18</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>在上一篇文章中以及讲述了ASan的结果怎么看，这里就不赘述了。</p>
<h3 id="crash-文件"><a href="#crash-文件" class="headerlink" title="crash 文件"></a>crash 文件</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-10a45a293f07e88f3b4651bcfc0dd2cf6cb6a162</span><br><span class="line">Base64: TGUw</span><br></pre></td></tr></table></figure>

<p>在日志最后会告知崩溃POC存放在当前目录，名称<code>crash-10a45a293f07e88f3b4651bcfc0dd2cf6cb6a162</code></p>
<h2 id="演示Heartbleed（心脏滴血）漏洞"><a href="#演示Heartbleed（心脏滴血）漏洞" class="headerlink" title="演示Heartbleed（心脏滴血）漏洞"></a>演示Heartbleed（心脏滴血）漏洞</h2><p>小插曲，如何高效的下载github仓库中的一个文件夹</p>
<blockquote>
<p>这是最现代、最“根正苗红”的 Git 官方方法。它允许你先克隆一个“空”的仓库结构，然后只拉取你指定的文件夹内容。</p>
<p><strong>优点</strong>:</p>
<ul>
<li>是 Git 的原生功能，功能强大。</li>
<li>后续如果想拉取其他文件夹或者更新，操作也很方便。</li>
</ul>
<p><strong>步骤</strong>:</p>
<ol>
<li><strong>克隆一个“空”仓库</strong><br>打开终端，运行以下命令。这会克隆仓库的元数据，但不会检出（下载）任何文件。</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --filter=blob:none --no-checkout https://github.com/google/fuzzer-test-suite</span><br></pre></td></tr></table></figure>
<ul>
<li><code>--filter=blob:none</code>: 告诉 Git 不要下载任何实际的文件内容 (blobs)。</li>
<li><code>--no-checkout</code>: 克隆后不要将文件检出到工作目录。</li>
</ul>
<ol start="2">
<li><strong>进入仓库目录</strong></li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> fuzzer-test-suite</span><br></pre></td></tr></table></figure>
<ol start="3">
<li><strong>指定你想要的文件夹</strong><br>这是最关键的一步。使用 <code>sparse-checkout</code> 命令告诉 Git 你只需要 <code>openssl-1.0.1f</code>。</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git sparse-checkout <span class="built_in">set</span> openssl-1.0.1f</span><br></pre></td></tr></table></figure>

<ol start="4">
<li><strong>检出文件</strong><br>现在，Git 会自动从远程仓库只下载并检出你指定的那个文件夹。<br>（在新版本的 Git 中，上一步的 <code>set</code> 命令通常会自动触发检出。如果执行完上一步后文件夹没出现，可以手动执行 <code>git checkout</code>。）</li>
</ol>
<p>现在你的 <code>fuzzer-test-suite</code> 目录里就只会有 <code>openssl-1.0.1f</code> 这一个文件夹了。</p>
</blockquote>
<p>这里多此一举了，还是需要把整个仓库clone下来的</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo1/ $ git <span class="built_in">clone</span> https://github.com/google/fuzzer-test-suite </span><br></pre></td></tr></table></figure>

<p>Heardbleed 漏洞是在 2014 年发现的 <a target="_blank" rel="noopener" href="https://www.openssl.org/">OpenSSL</a> 加密库中的一个严重漏洞，漏洞编号：CVE-2014-0160。该漏洞可以通过模糊测试的方式快速找到，在 Google 提供的 <code>fuzzer-test-suite</code> 项目中可以找到存在 heartbleed 漏洞的 <code>openssl-1.0.1f</code> 版本。</p>
<h3 id="build-和-target-说明"><a href="#build-和-target-说明" class="headerlink" title="build 和 target 说明"></a>build 和 target 说明</h3><p>将 <code>fuzzer-test-suite</code> 项目下载后，首先进入 <code>openssl-1.0.1f</code> 目录查看一下都有什么：</p>
<p><img data-src="/../images/image-20251006134355599.png" alt="image-20251006134355599"></p>
<p>这里主要有两个文件<code>build.sh</code>和<code>target.cc</code>，首先看一下<code>build.sh</code>中的内容</p>
<p><img data-src="/../images/image-20251006135339984.png" alt="image-20251006135339984"></p>
<p>build.sh中主要作用在于从git中拉取OpenSSL_1_0_1f版本源码放在当前路径下的SRC文件夹中，并在当前路径下创建BUILD文件夹，将SRC中的内容复制到BUILD中，接下来编译安装openssl。接下来利用libfuzzer和asan编译target.cc程序。最后将runtime文件夹下的公司钥复制到当前路径下的runtime中，接下来看target.cc：</p>
<p><img data-src="/../images/image-20251006140104131.png" alt="image-20251006140104131"></p>
<p>这里解释一下程序执行流程图，图中进阶去主函数部分，前面为Init()函数中的部分，主要进行openSSL初始化连接公私钥等内容。下面使用libfuzzer的LLVMFuzzerTestOneLnput()函数代替main()函数，看一下内部情况：</p>
<ul>
<li>28：建立SSL连接</li>
<li>29、30：创建内存型BIO输入参数sinbio和soutbio</li>
<li>31：设置SSL的获取和发送</li>
<li>32：将SSL设置为在服务器模式下工作</li>
<li>33：尝试将Size个字节从Data中写入BIO sinbio（Data内容和Size数量来自libfuzzer编译内容）</li>
<li>34：等待SSl&#x2F;TLS握手</li>
<li>35：释放内存</li>
</ul>
<h3 id="编译target文件"><a href="#编译target文件" class="headerlink" title="编译target文件"></a>编译target文件</h3><p>这里由于build.sh中已经编辑好了编译流程，所以我在我的demo1目录下创建一个heartbleed目录来直接运行build.sh：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo1/ $ <span class="built_in">cd</span> heartbleed</span><br><span class="line">le0n:heartbleed/ $ ../fuzzer-test-suite/openssl-1.0.1f/build.sh  </span><br></pre></td></tr></table></figure>

<p>运行结束后就可以看到编译好的<code>openssl-1.0.1f-fsanitize_fuzzer</code></p>
<p><img data-src="/../images/image-20251006142416104.png" alt="image-20251006142416104"></p>
<h3 id="执行fuzz"><a href="#执行fuzz" class="headerlink" title="执行fuzz"></a>执行fuzz</h3><p>接下来直接运行程序<code>openssl-1.0.1f-fsanitize_fuzzer</code>，由于libfuzzer在编译的时候就加入了源码，所以直接运行就开始跑了</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">le0n:heartbleed/ $ ./openssl-1.0.1f-fsanitize_fuzzer                                                                       [14:23:40]</span><br><span class="line">INFO: Running with entropic power schedule (0xFF, 100).</span><br><span class="line">INFO: Seed: 1074071809</span><br><span class="line">INFO: Loaded 1 modules   (35507 inline 8-bit counters): 35507 [0x5aa8345873d0, 0x5aa83458fe83),</span><br><span class="line">INFO: Loaded 1 PC tables (35507 PCs): 35507 [0x5aa83458fe88,0x5aa83461a9b8),</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line"><span class="comment">#2      INITED cov: 402 ft: 403 corp: 1/1b exec/s: 0 rss: 41Mb</span></span><br><span class="line"><span class="comment">#3      NEW    cov: 402 ft: 404 corp: 2/2b lim: 4 exec/s: 0 rss: 41Mb L: 1/1 MS: 1 ShuffleBytes-</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">#99448  NEW    cov: 639 ft: 1029 corp: 76/2907b lim: 526 exec/s: 49724 rss: 386Mb L: 18/352 MS: 1 ChangeBinInt-</span></span><br><span class="line"><span class="comment">#99669  REDUCE cov: 639 ft: 1029 corp: 76/2906b lim: 526 exec/s: 49834 rss: 386Mb L: 20/352 MS: 3 ChangeBinInt-CrossOver-EraseBytes-</span></span><br><span class="line"><span class="comment">#100362 REDUCE cov: 639 ft: 1029 corp: 76/2905b lim: 526 exec/s: 50181 rss: 386Mb L: 20/352 MS: 1 EraseBytes-</span></span><br><span class="line">=================================================================</span><br><span class="line">==12754==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x629000009748 at pc 0x5aa834088de7 bp 0x7fffa8b90770 sp 0x7fffa8b8ff40</span><br><span class="line">READ of size 32832 at 0x629000009748 thread T0</span><br><span class="line">    <span class="comment">#0 0x5aa834088de6 in __asan_memcpy (/home/le0n/fuzz/libFuzzer/demo1/heartbleed/openssl-1.0.1f-fsanitize_fuzzer+0x2a9de6) (BuildId: e47aecbd85f11ff5cb154f1c3d357a763363f5ff)</span></span><br><span class="line">    <span class="comment">#1 0x5aa8340d2d45 in tls1_process_heartbeat /home/le0n/fuzz/libFuzzer/demo1/heartbleed/BUILD/ssl/t1_lib.c:2586:3</span></span><br><span class="line">......</span><br><span class="line">    <span class="comment">#15 0x5aa833fd1a84 in _start (/home/le0n/fuzz/libFuzzer/demo1/heartbleed/openssl-1.0.1f-fsanitize_fuzzer+0x1f2a84) (BuildId: e47aecbd85f11ff5cb154f1c3d357a763363f5ff)</span></span><br><span class="line"></span><br><span class="line">0x629000009748 is located 0 bytes to the right of 17736-byte region [0x629000005200,0x629000009748)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x5aa834089abe in malloc (/home/le0n/fuzz/libFuzzer/demo1/heartbleed/openssl-1.0.1f-fsanitize_fuzzer+0x2aaabe) (BuildId: e47aecbd85f11ff5cb154f1c3d357a763363f5ff)</span></span><br><span class="line">......</span><br><span class="line">    <span class="comment">#12 0x7a8d84029d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/le0n/fuzz/libFuzzer/demo1/heartbleed/openssl-1.0.1f-fsanitize_fuzzer+0x2a9de6) (BuildId: e47aecbd85f11ff5cb154f1c3d357a763363f5ff) <span class="keyword">in</span> __asan_memcpy</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x0c527fff9290: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c527fff92a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c527fff92b0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c527fff92c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c527fff92d0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">=&gt;0x0c527fff92e0: 00 00 00 00 00 00 00 00 00[fa]fa fa fa fa fa fa</span><br><span class="line">  0x0c527fff92f0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c527fff9300: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c527fff9310: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c527fff9320: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c527fff9330: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07</span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="built_in">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      <span class="built_in">fc</span></span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">==12754==ABORTING</span><br><span class="line">MS: 2 CMP-ChangeBit- DE: <span class="string">&quot;\377\377\377\000\000\000\000\000&quot;</span>-; base unit: 6c3ded3648f8b5427b1287425de8775381e287ff</span><br><span class="line">0x3d,0x3,0x0,0x0,0x0,0x18,0x3,0x8,0x0,0x8,0x1,0x80,0x40,0x0,0x3,0xff,0xff,0xff,0x0,0x0,0x0,0x0,0x0,0x0,0x16,0x3,</span><br><span class="line">=\003\000\000\000\030\003\010\000\010\001\200@\000\003\377\377\377\000\000\000\000\000\000\026\003</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-ea955891f4388f1bf936c9f824c5081c1cd85a03</span><br><span class="line">Base64: PQMAAAAYAwgACAGAQAAD////AAAAAAAAFgM=</span><br></pre></td></tr></table></figure>

<p>可以看到 libfuzzer 在执行 <code>100362</code> 次后，共发现 <code>2905b</code> 中的 <code>76</code> 个输入项，覆盖 <code>639</code> 个基本块。后面 ASan 日志判定漏洞类型为 <strong>堆溢出</strong>，溢出执行位置pc、bp、sp分别在 <code>0x629000009748</code>、<code>0x7fffa8b90770</code>、<code>0x7fffa8b8ff40</code>。shadow 图中演示数据已经<code>溢出到相邻高地址堆块的头部</code>，fuzz过程中造成的crash已经保存在当前目录<code>crash-ea955891f4388f1bf936c9f824c5081c1cd85a03</code>。后续可以用 gdb 验证一下。</p>
<p>就先这样，下一篇写优化~</p>
<h3 id="gdb验证"><a href="#gdb验证" class="headerlink" title="gdb验证"></a>gdb验证</h3><p>使用 GDB 来验证和深入分析 Fuzzing 发现的崩溃是一个非常专业且有效的做法。它能让你从“程序崩溃了”的层面，深入到“程序为什么会以及如何在这里崩溃”的层面。</p>
<p>您看到的 Kali 上的文章，通常是使用现成的<strong>漏洞利用（Exploit）脚本</strong>，例如专门的 Python 脚本或 Metasploit 模块。这些工具的目的是<strong>利用漏洞</strong>，即从一个正在运行的、有漏洞的服务中窃取数据。</p>
<p>而我们使用 GDB 的目的不同，是为了<strong>调试和分析</strong>，即在本地重现崩溃，并观察程序在崩溃前的内存和变量状态，从而从根本上理解漏洞的成因。</p>
<p>下面，我将为您提供一个详细的、分步的 GDB 验证指南。</p>
<h4 id="核心思路"><a href="#核心思路" class="headerlink" title="核心思路"></a>核心思路</h4><p>ASan 在发现越界读取的<strong>瞬间</strong>就中止了程序，这很好，但它也阻止了我们观察“数据被完整拷贝出来”这个后续行为。为了在 GDB 中清晰地观察到数据泄露，我们需要一个<strong>没有 ASan</strong>但<strong>带有调试信息</strong>的可执行文件。</p>
<h4 id="第一步：重新编译一个用于-GDB-调试的版本"><a href="#第一步：重新编译一个用于-GDB-调试的版本" class="headerlink" title="第一步：重新编译一个用于 GDB 调试的版本"></a>第一步：重新编译一个用于 GDB 调试的版本</h4><p>这是最关键的一步。我们需要关闭 ASan，但开启 <code>-g</code> 标志来保留调试符号（函数名、行号等）。</p>
<ol>
<li><p><strong>回到构建目录</strong>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 假设您还在 heartbleed 目录下，先回到 fuzzer-test-suite 的根目录</span></span><br><span class="line"><span class="built_in">cd</span> ../fuzzer-test-suite/</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>修改构建脚本（临时）</strong>:<br>我们需要编辑 <code>common.sh</code> 文件，去掉 <code>-fsanitize</code> 相关的标志。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开 common.sh 文件</span></span><br><span class="line">nano common.sh</span><br></pre></td></tr></table></figure>
<p>找到下面这两行（或类似的行）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$CFLAGS</span> -fsanitize=address,fuzzer-no-link&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$CXXFLAGS</span> -fsanitize=address,fuzzer-no-link&quot;</span></span><br></pre></td></tr></table></figure>
<p>在它们前面加上 <code>#</code>，将它们注释掉。然后添加新的、只包含 <code>-g</code> 的行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># export CFLAGS=&quot;$CFLAGS -fsanitize=address,fuzzer-no-link&quot;</span></span><br><span class="line"><span class="comment"># export CXXFLAGS=&quot;$CXXFLAGS -fsanitize=address,fuzzer-no-link&quot;</span></span><br><span class="line"><span class="built_in">export</span> CFLAGS=<span class="string">&quot;<span class="variable">$CFLAGS</span> -g&quot;</span></span><br><span class="line"><span class="built_in">export</span> CXXFLAGS=<span class="string">&quot;<span class="variable">$CXXFLAGS</span> -g&quot;</span></span><br></pre></td></tr></table></figure>
<p>保存并退出 (<code>Ctrl+X</code>, <code>Y</code>, <code>Enter</code>)。</p>
</li>
<li><p><strong>重新构建</strong>:<br>现在，我们再次运行 <code>build.sh</code> 来生成一个带调试信息的新版本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> openssl-1.0.1f/</span><br><span class="line">./build.sh</span><br></pre></td></tr></table></figure>
<p>构建完成后，在 <code>fuzzer-test-suite/out/</code> 目录下会有一个新的 <code>openssl-1.0.1f</code> 可执行文件。这个文件就是我们用来 GDB 调试的目标。</p>
<p><strong>注意</strong>: 调试完成后，记得把 <code>common.sh</code> 文件改回去，以便将来继续进行 Fuzzing。</p>
</li>
</ol>
<h4 id="第二步：使用-GDB-启动并分析"><a href="#第二步：使用-GDB-启动并分析" class="headerlink" title="第二步：使用 GDB 启动并分析"></a>第二步：使用 GDB 启动并分析</h4><p>现在，我们有了可执行文件 (<code>out/openssl-1.0.1f</code>) 和导致崩溃的输入文件 (<code>crash-ea955891...</code>)。</p>
<ol>
<li><p><strong>启动 GDB</strong>:<br>使用 <code>--args</code> 参数来告诉 GDB 程序的命令行参数是什么。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 确保你在 fuzzer-test-suite 目录下</span></span><br><span class="line"><span class="comment"># 把 crash-ea95... 换成你实际的文件名</span></span><br><span class="line">gdb --args ./out/openssl-1.0.1f ./openssl-1.0.1f/crash-ea955891f4388f1bf936c9f824c5081c1cd85a03</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>设置断点</strong>:<br>根据之前的 ASan 报告，我们知道漏洞的关键函数是 <code>tls1_process_heartbeat</code>。我们就在这个函数的开头设置一个断点，这样程序一进入这个函数就会停下来。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b tls1_process_heartbeat</span><br><span class="line">Breakpoint 1 at 0x...: file ssl/t1_lib.c, line 2508.</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>运行程序</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) run</span><br></pre></td></tr></table></figure>
<p>程序会开始执行，然后停在我们设置的断点处。</p>
</li>
<li><p><strong>检查关键变量 (核心步骤)</strong>:<br>心脏滴血漏洞的核心是程序相信了客户端发来的<strong>长度</strong>字段。在 <code>tls1_process_heartbeat</code> 函数中，有两个关键变量：</p>
<ul>
<li><code>p</code>: 一个指向心跳请求负载开头的指针 (<code>unsigned char *</code>)。</li>
<li><code>payload</code>: 从请求中读取到的负载长度 (<code>unsigned int</code>)。</li>
</ul>
<p>让我们打印出这两个变量的值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 打印 payload 变量的值</span><br><span class="line">(gdb) p payload</span><br><span class="line">$1 = 65535  # 你可能会看到一个很大的数字，比如 65535 或其他</span><br><span class="line"></span><br><span class="line"># 打印 p 指向的内存内容（也就是实际的 payload）</span><br><span class="line"># x/16xb p 的意思是：以 16 进制、字节为单位，显示 p 指针后的 16 个字节</span><br><span class="line">(gdb) x/16xb p</span><br><span class="line">0x...: 0x18 0x03 0x01 0x00 0x01 0x01 0x02 0x03 ...</span><br></pre></td></tr></table></figure>

<p><strong>分析</strong>:<br>此时你会看到一个巨大的矛盾：<code>payload</code> 的值非常大（比如几万），但 <code>p</code> 指针指向的实际数据非常短。Fuzzer 正是构造了这样一个畸形的数据包！</p>
</li>
<li><p><strong>观察 <code>memcpy</code> 行为</strong>:<br>现在，我们单步执行，直到找到那个致命的 <code>memcpy</code>。</p>
<ul>
<li>不断输入 <code>n</code> (next) 来执行下一行代码。</li>
<li>你会找到类似下面这行代码：<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(bp, pl, payload);</span><br></pre></td></tr></table></figure>
这里 <code>bp</code> 是目标缓冲区，<code>pl</code> 是源（和我们之前看的 <code>p</code> 差不多），而 <code>payload</code> 就是那个被我们信任了的、巨大的长度。</li>
</ul>
</li>
<li><p><strong>见证数据泄露</strong>:</p>
<ul>
<li><strong>在 <code>memcpy</code> 执行前</strong>，我们先看一下目标缓冲区 <code>bp</code> 里的内容。它可能是空的，也可能是一些垃圾数据。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/64xb bp</span><br></pre></td></tr></table></figure></li>
<li><strong>执行 <code>memcpy</code></strong>: 输入 <code>n</code>，让这行 <code>memcpy</code> 执行完毕。由于没有 ASan，程序现在不会崩溃，而是会忠实地执行这个越界读取！</li>
<li><strong>在 <code>memcpy</code> 执行后</strong>，我们再次检查 <code>bp</code> 缓冲区的内容。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/64xb bp</span><br></pre></td></tr></table></figure>
<strong>你会看到，<code>bp</code> 缓冲区现在不仅包含了原始的那一小段 payload，后面还跟了一大串从其他内存区域复制过来的数据！这些紧跟在原始数据包后面的、本不应该被读取的数据，就是“心脏滴血”泄露出来的信息。</strong></li>
</ul>
</li>
<li><p><strong>退出 GDB</strong>:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(gdb) quit</span><br></pre></td></tr></table></figure></li>
</ol>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>通过 GDB，您亲眼见证了心脏滴血漏洞的完整过程：</p>
<ol>
<li>程序接收到一个<strong>长度字段与实际数据大小不符</strong>的恶意心跳包。</li>
<li>程序<strong>盲目信任</strong>了这个长度字段。</li>
<li>在 <code>tls1_process_heartbeat</code> 函数中，程序调用 <code>memcpy</code>，试图复制这个超长的数据。</li>
<li><code>memcpy</code> 越过了原始数据包的边界，将<strong>相邻内存中的敏感数据</strong>一并复制到了用于响应的缓冲区中。</li>
<li>这些数据最终会被发回给攻击者，造成严重的信息泄露。</li>
</ol>
<p>这个过程比单纯看 ASan 报告要直观得多，它让你真正理解了<strong>为什么一个缓冲区溢出（Buffer Overflow）会导致一个信息泄露（Information Disclosure）漏洞</strong>。</p>
<h1 id="LibFuzzer学习（二）：提高代码覆盖率和速度"><a href="#LibFuzzer学习（二）：提高代码覆盖率和速度" class="headerlink" title="LibFuzzer学习（二）：提高代码覆盖率和速度"></a>LibFuzzer学习（二）：提高代码覆盖率和速度</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前一篇文章中展示了 libfuzzer 的基本用法，在实际的 <strong>模糊测试</strong> 过程中，仅仅使用基本的用法会消耗非常多的时间，也会因为代码覆盖率不足的原因导致找不到想要的漏洞。这就需要通过一些技巧来提升代码覆盖率和速度。</p>
<h2 id="指定seed-corpus提高代码覆盖率"><a href="#指定seed-corpus提高代码覆盖率" class="headerlink" title="指定seed corpus提高代码覆盖率"></a>指定seed corpus提高代码覆盖率</h2><p>这里我们拿 Google 的 woff2 进行举例，可以在 <strong>fuzzer-test-suite</strong> 项目中找到 <strong>woff2-2016-05-06</strong> 项目的 build 文件，该项目主要用于利用 brotli 压缩算法压缩 woff2 格式字体。</p>
<p>本次实验重点在于比较使用 <strong>seed corpus</strong> 前后代码覆盖率差别，以及提高代码覆盖率带来的好处。</p>
<p>这里首先简单的介绍一下本次实验 <strong>woff2-2016-05-06</strong> 目录下的两个重要文件，一个是 <code>build.sh</code>，另外一个是 <code>target.cc</code>。首先看 <code>build.sh</code> 文档。</p>
<p><img data-src="/../images/image-20251006153424312.png" alt="image-20251006153424312"></p>
<ul>
<li>7、8、9 行：将 woff2、brotli、roboto 项目分别下载到当前目录的 <code>SRC</code>、<code>BROTYLI</code>、<code>seeds</code> 文件夹中。</li>
<li>13-15 行：添加目录包括 <code>BROTLI/de</code> 和 <code>BROTLI/enc</code> 搜索路径，循环换个编译 <code>font.cc</code>、<code>normalize.cc</code>、<code>transform.cc</code>、<code>woff2_common.cc</code>、<code>woff2_dec.cc</code>、<code>woff2_enc.cc</code>、<code>glyph.cc</code>、<code>table_tags.cc</code>、<code>variable_length.cc</code>、<code>woff2_out.cc</code> 文件。</li>
<li>16-18 行：编译 <code>BROTLI/de</code> 和 <code>BROTLI/enc</code> 路径下所有源文件。</li>
<li>26 行：启用 <code>LibFuzzer</code> 和 <code>ASAN</code> 编译 <code>target.cc</code> 文件。</li>
</ul>
<p>接下来看看 <code>target.cc</code> 文件。</p>
<p><img data-src="/../images/image-20251006154652685.png" alt="image-20251006154652685"></p>
<p><code>target.cc</code> 文件中的内容是比较简单的，使用 <code>LLVMFuzzerTestOneInput</code> 代替程序中原本的 <code>main</code> 函数，借助 <code>LibFuzzer</code> 可以再程序内部提供输入，主函数中关键函数为 <code>woff2::ConvertWOFF2ToTTF()</code>，将 Woff2 格式文件转换成 TTF 格式文件，参数 <code>data</code> 和 <code>size</code> 由 <code>LibFuzzer</code> 提供传入。 接下来在创建一个文件夹，并运行 <code>build.sh</code>：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">le0n:libFuzzer/ $ <span class="built_in">mkdir</span> demo2 </span><br><span class="line">le0n:libFuzzer/ $ <span class="built_in">ls</span></span><br><span class="line">demo1  demo2  fuzzer-test-suite</span><br><span class="line">le0n:libFuzzer/ $ <span class="built_in">cd</span> demo2    </span><br><span class="line">le0n:demo2/ $ ../fuzzer-test-suite/woff2-2016-05-06/build.sh   </span><br></pre></td></tr></table></figure>

<p>运行后，将会看到编译成功的可执行文件 <code>woff2-2016-05-06-fsanitize_fuzzer</code>，以及编译好的各项库文件。</p>
<h3 id="正常使用libfuzzer"><a href="#正常使用libfuzzer" class="headerlink" title="正常使用libfuzzer"></a>正常使用libfuzzer</h3><p>正常使用libfuzzer只需要运行一下<code>./woff2-2016-05-06-fsanitize_fuzzer</code>，接下来看libfuzzer和ASan的日志</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo2/ $ ./woff2-2016-05-06-fsanitize_fuzzer</span><br><span class="line">INFO: Running with entropic power schedule (0xFF, 100).</span><br><span class="line">INFO: Seed: 2379482884</span><br><span class="line">INFO: Loaded 1 modules   (10840 inline 8-bit counters): 10840 [0x5bda00b03070, 0x5bda00b05ac8),</span><br><span class="line">INFO: Loaded 1 PC tables (10840 PCs): 10840 [0x5bda00b05ac8,0x5bda00b30048),</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 4096 bytes</span><br><span class="line">INFO: A corpus is not provided, starting from an empty corpus</span><br><span class="line"><span class="comment">#2      INITED cov: 15 ft: 16 corp: 1/1b exec/s: 0 rss: 32Mb</span></span><br><span class="line"><span class="comment">#22     NEW    cov: 16 ft: 17 corp: 2/5b lim: 4 exec/s: 0 rss: 32Mb L: 4/4 MS: 5 CopyPart-ChangeBinInt-CrossOver-ChangeBit-CopyPart-</span></span><br><span class="line"><span class="comment">#637    NEW    cov: 17 ft: 18 corp: 3/11b lim: 8 exec/s: 0 rss: 32Mb L: 6/6 MS: 5 CopyPart-CMP-InsertByte-ChangeBinInt-ShuffleBytes- DE: &quot;2FOw&quot;-</span></span><br><span class="line"><span class="comment">#678    REDUCE cov: 17 ft: 18 corp: 3/10b lim: 8 exec/s: 0 rss: 32Mb L: 5/5 MS: 1 CrossOver-</span></span><br><span class="line"><span class="comment">#769    REDUCE cov: 18 ft: 19 corp: 4/18b lim: 8 exec/s: 0 rss: 32Mb L: 8/8 MS: 1 CrossOver-</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">#13911997       NEW    cov: 622 ft: 1087 corp: 317/21Kb lim: 4096 exec/s: 70619 rss: 392Mb L: 56/289 MS: 1 ChangeBinInt-</span></span><br><span class="line"><span class="comment">#13937934       NEW    cov: 624 ft: 1089 corp: 318/21Kb lim: 4096 exec/s: 70393 rss: 392Mb L: 56/289 MS: 2 ChangeBinInt-ShuffleBytes-</span></span><br><span class="line">==36942== ERROR: libFuzzer: out-of-memory (malloc(2439171686))</span><br><span class="line">   To change the out-of-memory <span class="built_in">limit</span> use -rss_limit_mb=&lt;N&gt;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#0 0x5bda008cfb01 in __sanitizer_print_stack_trace (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x12bb01) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#1 0x5bda00842398 in fuzzer::PrintStackTrace() (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x9e398) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#2 0x5bda00827085 in fuzzer::Fuzzer::HandleMalloc(unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x83085) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#3 0x5bda00826f9a in fuzzer::MallocHook(void const volatile*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x82f9a) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#4 0x5bda008d6f87 in __sanitizer::RunMallocHooks(void const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x132f87) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#5 0x5bda00845684 in __asan::Allocator::Allocate(unsigned long, unsigned long, __sanitizer::BufferedStackTrace*, __asan::AllocType, bool) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0xa1684) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#6 0x5bda00845cd9 in __asan::asan_memalign(unsigned long, unsigned long, __sanitizer::BufferedStackTrace*, __asan::AllocType) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0xa1cd9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#7 0x5bda00900832 in operator new(unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x15c832) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#8 0x5bda009ff4fe in allocate /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/ext/new_allocator.h:127:27</span></span><br><span class="line">    <span class="comment">#9 0x5bda009ff4fe in allocate /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/alloc_traits.h:464:20</span></span><br><span class="line">    <span class="comment">#10 0x5bda009ff4fe in _M_allocate /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/stl_vector.h:346:20</span></span><br><span class="line">    <span class="comment">#11 0x5bda009ff4fe in _M_create_storage /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/stl_vector.h:361:33</span></span><br><span class="line">    <span class="comment">#12 0x5bda009ff4fe in _Vector_base /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/stl_vector.h:305:9</span></span><br><span class="line">    <span class="comment">#13 0x5bda009ff4fe in vector /usr/bin/../lib/gcc/x86_64-linux-gnu/11/../../../../include/c++/11/bits/stl_vector.h:511:9</span></span><br><span class="line">    <span class="comment">#14 0x5bda009ff4fe in woff2::ConvertWOFF2ToTTF(unsigned char const*, unsigned long, woff2::WOFF2Out*) /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:1274:24</span></span><br><span class="line">    <span class="comment">#15 0x5bda00a166d0 in LLVMFuzzerTestOneInput /home/le0n/fuzz/libFuzzer/demo2/../fuzzer-test-suite/woff2-2016-05-06/target.cc:13:3</span></span><br><span class="line">    <span class="comment">#16 0x5bda008293a3 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x853a3) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#17 0x5bda00828af9 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x84af9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#18 0x5bda0082a2e9 in fuzzer::Fuzzer::MutateAndTestOne() (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x862e9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#19 0x5bda0082ae65 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, std::allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x86e65) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#20 0x5bda00818fa2 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x74fa2) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#21 0x5bda00842c92 in main (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x9ec92) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#22 0x7d38f2629d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line">    <span class="comment">#23 0x7d38f2629e3f in __libc_start_main csu/../csu/libc-start.c:392:3</span></span><br><span class="line">    <span class="comment">#24 0x5bda0080d9e4 in _start (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x699e4) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line"></span><br><span class="line">MS: 4 ShuffleBytes-ChangeByte-ChangeByte-ChangeBinInt-; base unit: d49d0ae17c1bc8ece65328113ba74c187b5cb627</span><br><span class="line">0x77,0x4f,0x46,0x32,0x0,0x0,0xa,0x0,0x0,0x0,0x0,0x38,0x0,0x1,0x36,0x0,0xfc,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0xab,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x2,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x77,0x0,0x89,0x8b,0x8b,0x9c,0x66,0x6b,0x4,</span><br><span class="line">wOF2\000\000\012\000\000\000\0008\000\0016\000\374\000\000\000\000\000\000\000\000\253\000\002\000\000\000\000\000\000\000\000\000\000\002\000\000\000\000\000\000\000\000w\000\211\213\213\234fk\004</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./oom-93c3659d17d213c13cac023c5d0dbf9f538de819</span><br><span class="line">Base64: d09GMgAACgAAAAA4AAE2APwAAAAAAAAAAKsAAgAAAAAAAAAAAAACAAAAAAAAAAB3AImLi5xmawQ=</span><br><span class="line">SUMMARY: libFuzzer: out-of-memory</span><br></pre></td></tr></table></figure>

<p>可以看到 <code>LibFuzzer</code> 尝试执行了 <code>13937934</code> 次，发现了 <code>21kb</code> 个字节中 <code>318</code> 个输入字节，覆盖 <code>624</code> 个代码块，最后检查到的结果仅仅是一个 <code>OOM</code>。 <code>OOM</code>样例存储在当前目录下 <code>oom-93c3659d17d213c13cac023c5d0dbf9f538de819</code>。</p>
<p>这里其实是有一些问题的，一般即使是轻量级运行库，代码覆盖率只达到 <code>624</code>，实际上是有点少的。这是因为启动 <code>LibFuzzer</code> 的时候仅仅通过自带的 <code>seed</code> 进行变化，即使消耗了大量的内存，也不能在规定时间内找到新的 <code>path</code>。</p>
<h3 id="指定seed-corpus再次执行libfuzzer"><a href="#指定seed-corpus再次执行libfuzzer" class="headerlink" title="指定seed corpus再次执行libfuzzer"></a>指定seed corpus再次执行libfuzzer</h3><p>在上面build.sh文件中，其实已经下载好了一些seed，存放在当前目录的seeds文件夹中：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo2/ $ <span class="built_in">ls</span> seeds</span><br><span class="line">README.md  fonts  index.html  less  package.json  roboto.css  roboto.css.map  roboto.scss  sass</span><br><span class="line">le0n:demo2/ $  </span><br></pre></td></tr></table></figure>

<p>其中有很多的文件可以作为本次模糊测试的seed corpus，所以系欸笑傲了就可以创建一个文件夹，每次编译后的输入会保存到这个文件夹中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo2/ $ <span class="built_in">mkdir</span> out     </span><br><span class="line">le0n:demo2/ $ ./woff2-2016-05-06-fsanitize_fuzzer ./out ./seeds </span><br></pre></td></tr></table></figure>

<p>这样就制定了seed corpus，并将每次编译后的输入保存到<code>out</code>文件夹中。看一下输出日志：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo2/ $ ./woff2-2016-05-06-fsanitize_fuzzer ./out ./seeds                                                                                           [15:55:38]</span><br><span class="line">INFO: Running with entropic power schedule (0xFF, 100).</span><br><span class="line">INFO: Seed: 3611030366</span><br><span class="line">INFO: Loaded 1 modules   (10840 inline 8-bit counters): 10840 [0x5ad55adec070, 0x5ad55adeeac8),</span><br><span class="line">INFO: Loaded 1 PC tables (10840 PCs): 10840 [0x5ad55adeeac8,0x5ad55ae19048),</span><br><span class="line">INFO:        0 files found <span class="keyword">in</span> ./out</span><br><span class="line">INFO:       62 files found <span class="keyword">in</span> ./seeds</span><br><span class="line">INFO: -max_len is not provided; libFuzzer will not generate inputs larger than 168276 bytes</span><br><span class="line">INFO: seed corpus: files: 62 min: 14b max: 168276b total: 3896056b rss: 31Mb</span><br><span class="line"><span class="comment">#63     INITED cov: 678 ft: 1187 corp: 13/766Kb exec/s: 0 rss: 56Mb</span></span><br><span class="line"><span class="comment">#64     NEW    cov: 683 ft: 1258 corp: 14/828Kb lim: 68784 exec/s: 0 rss: 57Mb L: 63752/68784 MS: 1 ChangeByte-NEW_FUNC[1/1]: 0x5ad55ac802f0 in TransformDictionaryWord(unsigned char*, unsigned char const*, int, int) /home/le0n/fuzz/libFuzzer/demo2/BROTLI/dec/./transform.h:261</span></span><br><span class="line"><span class="comment">#70     NEW    cov: 702 ft: 1292 corp: 15/896Kb lim: 68784 exec/s: 0 rss: 59Mb L: 68688/68784 MS: 1 ChangeByte-</span></span><br><span class="line">......</span><br><span class="line"><span class="comment">#4941958        NEW    cov: 1047 ft: 4011 corp: 905/56Mb lim: 113600 exec/s: 3290 rss: 860Mb L: 67832/68784 MS: 1 CopyPart-</span></span><br><span class="line"><span class="comment">#4968156        NEW    cov: 1048 ft: 4012 corp: 906/56Mb lim: 113856 exec/s: 3292 rss: 860Mb L: 67832/68784 MS: 3 ChangeASCIIInt-ShuffleBytes-CrossOver-</span></span><br><span class="line">=================================================================</span><br><span class="line">==35385==ERROR: AddressSanitizer: heap-buffer-overflow on address 0x6290000aeb81 at pc 0x5ad55abaddfa bp 0x7ffc00e14130 sp 0x7ffc00e13900</span><br><span class="line">WRITE of size 18801 at 0x6290000aeb81 thread T0</span><br><span class="line">    <span class="comment">#0 0x5ad55abaddf9 in __asan_memcpy (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x120df9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#1 0x5ad55acec381 in Read /home/le0n/fuzz/libFuzzer/demo2/SRC/src/./buffer.h:86:7</span></span><br><span class="line">    <span class="comment">#2 0x5ad55acec381 in ReconstructGlyf /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:500:13</span></span><br><span class="line">    <span class="comment">#3 0x5ad55acec381 in ReconstructFont /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:917:15</span></span><br><span class="line">    <span class="comment">#4 0x5ad55acec381 in woff2::ConvertWOFF2ToTTF(unsigned char const*, unsigned long, woff2::WOFF2Out*) /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:1282:9</span></span><br><span class="line">    <span class="comment">#5 0x5ad55acff6d0 in LLVMFuzzerTestOneInput /home/le0n/fuzz/libFuzzer/demo2/../fuzzer-test-suite/woff2-2016-05-06/target.cc:13:3</span></span><br><span class="line">    <span class="comment">#6 0x5ad55ab123a3 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x853a3) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#7 0x5ad55ab11af9 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x84af9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#8 0x5ad55ab132e9 in fuzzer::Fuzzer::MutateAndTestOne() (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x862e9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#9 0x5ad55ab13e65 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, std::allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x86e65) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#10 0x5ad55ab01fa2 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x74fa2) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#11 0x5ad55ab2bc92 in main (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x9ec92) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#12 0x717cb7629d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line">    <span class="comment">#13 0x717cb7629e3f in __libc_start_main csu/../csu/libc-start.c:392:3</span></span><br><span class="line">    <span class="comment">#14 0x5ad55aaf69e4 in _start (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x699e4) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line"></span><br><span class="line">0x6290000aeb81 is located 0 bytes to the right of 18817-byte region [0x6290000aa200,0x6290000aeb81)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    <span class="comment">#0 0x5ad55abe98dd in operator new[](unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x15c8dd) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#1 0x5ad55acee2b9 in ReconstructGlyf /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:483:25</span></span><br><span class="line">    <span class="comment">#2 0x5ad55acee2b9 in ReconstructFont /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:917:15</span></span><br><span class="line">    <span class="comment">#3 0x5ad55acee2b9 in woff2::ConvertWOFF2ToTTF(unsigned char const*, unsigned long, woff2::WOFF2Out*) /home/le0n/fuzz/libFuzzer/demo2/SRC/src/woff2_dec.cc:1282:9</span></span><br><span class="line">    <span class="comment">#4 0x5ad55acff6d0 in LLVMFuzzerTestOneInput /home/le0n/fuzz/libFuzzer/demo2/../fuzzer-test-suite/woff2-2016-05-06/target.cc:13:3</span></span><br><span class="line">    <span class="comment">#5 0x5ad55ab123a3 in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x853a3) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#6 0x5ad55ab11af9 in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool, bool*) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x84af9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#7 0x5ad55ab132e9 in fuzzer::Fuzzer::MutateAndTestOne() (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x862e9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#8 0x5ad55ab13e65 in fuzzer::Fuzzer::Loop(std::vector&lt;fuzzer::SizedFile, std::allocator&lt;fuzzer::SizedFile&gt; &gt;&amp;) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x86e65) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#9 0x5ad55ab01fa2 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x74fa2) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#10 0x5ad55ab2bc92 in main (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x9ec92) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37)</span></span><br><span class="line">    <span class="comment">#11 0x717cb7629d8f in __libc_start_call_main csu/../sysdeps/nptl/libc_start_call_main.h:58:16</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/le0n/fuzz/libFuzzer/demo2/woff2-2016-05-06-fsanitize_fuzzer+0x120df9) (BuildId: 396f1a60e878f787ff7093be06563de75c467f37) <span class="keyword">in</span> __asan_memcpy</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  0x0c528000dd20: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c528000dd30: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c528000dd40: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c528000dd50: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">  0x0c528000dd60: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00</span><br><span class="line">=&gt;0x0c528000dd70:[01]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c528000dd80: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c528000dd90: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c528000dda0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c528000ddb0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  0x0c528000ddc0: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07</span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="built_in">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      <span class="built_in">fc</span></span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">==35385==ABORTING</span><br><span class="line">MS: 1 ChangeByte-; base unit: ff41f056b7e38068e1057c2641af6456baa5daa1</span><br><span class="line">artifact_prefix=<span class="string">&#x27;./&#x27;</span>; Test unit written to ./crash-558d58bf06923fd30cba47a6817c123332a79f60</span><br></pre></td></tr></table></figure>

<p>根据日志可以看到本次fuzz载入了seeds目录下的62个文件，共尝试了<code>4968156</code>次共发现<code>56MB</code>字节中的<code>906</code>个输入字节，共覆盖<code>1048</code>个基本快。并且发现了一个堆溢出漏洞。crash结果存放在当前目录的<code>crash-558d58bf06923fd30cba47a6817c123332a79f6</code></p>
<p><strong>对比未使用seed corpus时的覆盖情况：</strong></p>
<p><img data-src="/../images/image-20251006201826212.png" alt="image-20251006201826212"></p>
<p><img data-src="/../images/image-20251006201839442.png" alt="image-20251006201839442"></p>
<p>可以看到在使用seed corpus后libfuzzer在尝试次数减少的同时，<code>代码覆盖率相比之前提高了424个基本块</code>。这也导致了libfuzzer发现了新路径中的堆溢出路径</p>
<p>也可以在out文件夹中看到每次变异后的数据：</p>
<p><img data-src="/../images/image-20251006202139274.png" alt="image-20251006202139274"></p>
<p>嗯，非常之多</p>
<h2 id="使用多核并行fuzz"><a href="#使用多核并行fuzz" class="headerlink" title="使用多核并行fuzz"></a>使用多核并行fuzz</h2><p>和AFL一样，LibFuzzer也提供使用多核并行fuzz。每个LibFuzzer进程都是单进程，但是可以在seed corpus目录中并行开启多个LibFuzzer进程，这样来一个fuzzer进程找到的任何新输入都可以为其他fuzzer进程提供帮助。</p>
<p>可以使用 <code>-jobs=N</code> 参数进行设置，这里需要注意的是 <code>N</code> 并不代表使用的核心，而是设定的 <code>fuzzing job</code>。LibFuzzer在指定<code>-jobs</code>参数后，这些fuzzing job将会由 <code>worker</code> 进行处理，worker数量默认认为是CPU核心数的一半。这是举个例子，<code>-job=40</code> 在16核心上运行，默认会执行8个worker处理40个fuzzing job，当其中一个worker完成已分配的fuzzing job后，将会从剩下的32个fuzzing job中再分配一个job给worker。</p>
<p>还是用woff2进行举例，指定 <code>-jobs=8</code>（服务器 16 核）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./woff2-2016-05-06-fsanitize_fuzzer -<span class="built_in">jobs</span>=8 out/ seeds/</span><br></pre></td></tr></table></figure>

<p>由于我的wsl2可以使用主机的16核，所以LibFuzzer会启用8个worker来处理这8个fuzzing job，每个worker处理的结果日志会分别放在当前目录下 <code>fuzz-0~7.log</code> 文件中。可以看到job 2首先发现了一个崩溃的时间。</p>
<p>在之前未使用并行，但使用seed corpus进行模糊测试，出现崩溃所用的时间大概是 <strong>15分钟左右</strong>。本次由于使用seed corpus和并行执行，发现一次发现崩溃的时间 <strong>不到2分钟</strong>。</p>
<p>8个worker执行日志及跑出来的crash结果将会在当前路径下看到（我提前中断了）：</p>
<p><img data-src="/../images/image-20251006202935797.png" alt="image-20251006202935797"></p>
<h2 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h2><p>另外一种提升速度的方式就是使用字典辅助进行模糊测试，可以在被测试程序执行时添加 <code>-dict=dictionaries_path</code>。</p>
<h3 id="测试项目构建"><a href="#测试项目构建" class="headerlink" title="测试项目构建"></a>测试项目构建</h3><p>这里选择之前使用AFL++测试的libxml2项目进行举例。同时，可以在fuzzer-test-suite项目中找到对应的项目build路径（fuzzer-test-suite&#x2F;libxml2-v2.9.2&#x2F;），其中比较重要的文件有两个：<code>build.sh</code> 和 <code>target.cc</code>。这是先看一下一下 <code>build.sh</code>。</p>
<p><img data-src="/../images/image-20251006204547504.png" alt="image-20251006204547504"></p>
<p>这个 <code>build.sh</code> 脚本我做了一些小的改动，下面稍微做一下分析：</p>
<ul>
<li><strong>13行</strong>：将2.9.2版本的libxml2下载到当前目录的SRC文件夹中。</li>
<li><strong>14行</strong>：这里做了第一次更改，源脚本中这里下载了一个AFL，目的是为了用AFL项目中的xml.dict字典，因为我的虚拟机里本来就有AFL++，在字典目录中同样有这个字典，所以就把这里给注释掉了。当然如果你的环境中没有AFL或AFL++也可以不把这里注释掉，或者注释掉后单独下载自己习惯用的字典。</li>
<li><strong>15, 7~11行</strong>：这里主要是构建libxml2，将项目源代码拷贝到BUILD目录中进行编译。</li>
<li><strong>18, 19行</strong>：这里是第二个修改的小地方，原来是将AFL字典目录下的xml.dict拷贝到当前目录，前面也说了，本身环境中AFL++的字典。</li>
<li><strong>21~26行</strong>：使用LibFuzzer变量导入target.cc程序。</li>
</ul>
<p>接下来看看一下 <code>target.cc</code> 内部程序流：</p>
<p><img data-src="/../images/image-20251006204825371.png" alt="image-20251006204825371"></p>
<p><code>target.cc</code> 内部调用也非常简单，首先将 <code>main()</code> 函数替换为 LibFuzzer 的 <code>LLVMFuzzerTestOneInput()</code> 函数，接下来调用 <code>xmlSetGenericErrorFunc()</code> 函数来进行异常处理，接下来的目标函数 <code>xmlReadMemory()</code> 这个函数是用来解析内存中的 XML 文档并构建树，一参数指向的是 xml 内存数据数组地址，二参数数组长度（<a target="_blank" rel="noopener" href="https://www.xmlsoft.org/html/libxml-parser.html#xmlReadMemory">官方文档</a>）。由 <code>LLVMFuzzerTestOneInput()</code> 函数随机生成的数据 <code>data</code> 作为 <code>xmlReadMemory()</code> 的一参，<code>size</code>作为二参 </p>
<p>构建文档和目标文件解释完了，接下来可以在主目录为本次 libxml2 实验创建一个单独的文件夹，并运行 <code>build.sh</code> 就可以了：</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo3/ $ ../fuzzer-test-suite/libxml2-v2.9.2/build.sh </span><br></pre></td></tr></table></figure>

<p> 运行时由于需要从 <code>git</code> 上获取项目，所以请保持网络畅通，运行结束将会在当前文件夹下看到存放源代码的 <code>SRC</code> 文件夹、存放库文件的 <code>BUILD</code> 文件夹、LibFuzzer 测试程序 <code>libxml2-v2.9.2-fsanitize_fuzzer</code> 和字典 <code>xml.dict</code>。</p>
<p><img data-src="/../images/image-20251006205240330.png" alt="image-20251006205240330"></p>
<h3 id="比对代码覆盖率"><a href="#比对代码覆盖率" class="headerlink" title="比对代码覆盖率"></a>比对代码覆盖率</h3><p>为了展示使用字典能够提升效率的效果，这里可以做一个小实验：两次执行 LibFuzzer 测试程序，第一次不带字典执行，第二次带字典执行。</p>
<p>在相同的时间内 <code>ctrl+c</code> 中断，两次执行中断时基本块覆盖情况：</p>
<p>第一次不带字典执行，运行 15 秒后 <code>ctrl+c</code> 中断。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo3/ $ ./libxml2-v2.9.2-fsanitize_fuzzer </span><br></pre></td></tr></table></figure>

<p><img data-src="/../images/image-20251006205823898.png" alt="image-20251006205823898"></p>
<p>第二次带字典执行，运行 15 秒后中断</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">le0n:demo3/ $ ./libxml2-v2.9.2-fsanitize_fuzzer -dict=xml.dict </span><br></pre></td></tr></table></figure>

<p><img data-src="/../images/image-20251006210008026.png" alt="image-20251006210008026"></p>
<p>可以看到添加字典后运行覆盖的基本块要比未使用字典运行覆盖的基本块要多<code>841</code>，所以使用字典一定程度上提高fuzz的效率。libxml2就不跑了，在之前的afl++中已经跑过了</p>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>Post author:  </strong>leon
  </li>
  <li class="post-copyright-link">
      <strong>Post link: </strong>
      <a href="http://example.com/2025/10/04/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%BA%8C%EF%BC%89/" title="fuzz入门到入土（二）">http://example.com/2025/10/04/fuzz从入门到入土（二）/</a>
  </li>
  <li class="post-copyright-license">
      <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/en" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/fuzz/" rel="tag"><i class="fa fa-tag"></i> fuzz</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/09/16/fuzz%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E5%85%A5%E5%9C%9F%EF%BC%88%E4%B8%80%EF%BC%89/" rel="prev" title="fuzz入门到入土（一）">
                  <i class="fa fa-angle-left"></i> fuzz入门到入土（一）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/12/18/%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E5%85%A8%E5%BA%B7%E5%A4%8D%E8%AE%AD%E7%BB%83/" rel="next" title="ctf pwn康复训练">
                  ctf pwn康复训练 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">leon</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="Word count total">672k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">10:11</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>

  <a href="https://github.com/le0n-daily" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/next-theme-pjax/0.6.0/pjax.min.js" integrity="sha256-vxLn1tSKWD4dqbMRyv940UYw4sXgMtYcK6reefzZrao=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.31/fancybox/fancybox.umd.js" integrity="sha256-a+H7FYzJv6oU2hfsfDGM2Ohw/cR9v+hPfxHCLdmCrE8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lozad.js/1.16.0/lozad.min.js" integrity="sha256-mOFREFhqmHeQbXpK2lp4nA3qooVgACfh88fpJftLBbc=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pangu/4.0.7/pangu.min.js" integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script src="/js/pjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/11.4.0/mermaid.min.js","integrity":"sha256-G8ouPAnw4zzMbnAenHnVz6h9XpKbNdOkrqTh7AadyHs="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  <script src="/js/third-party/fancybox.js"></script>



  
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/js/third-party/math/mathjax.js"></script>



</body>
</html>
